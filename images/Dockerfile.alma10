FROM quay.io/kairos/kairos-init:v0.7.0@sha256:d305713102d1d476bae919f71de1bc6ff09faf75e4cb4aaad1a122aaaa340e03 AS kairos-init

FROM almalinux:10@sha256:a81adef1de0ec017d2f483e6acedf6da4c060a93716192c23cac052386e48035 AS base-kairos

ARG KUBERNETES_DISTRO=k3s
ARG K8S_VERSION_FLAG="--provider-${KUBERNETES_DISTRO}-version"
# renovate: datasource=custom.k3s depName=k3s
ARG KUBERNETES_VERSION=v1.35.0+k3s1
ARG MODEL=generic
ARG TRUSTED_BOOT=false
ARG VERSION

COPY --from=kairos-init /kairos-init /kairos-init

# hadolint ignore=DL3059
RUN /kairos-init \
  -s install \
  --fips \
  -p "${KUBERNETES_DISTRO}" \
  "${K8S_VERSION_FLAG}" "${KUBERNETES_VERSION}" \
  -l debug \
  -m "${MODEL}" \
  -t "${TRUSTED_BOOT}" \
  --version "${VERSION}"

# hadolint ignore=DL3041
RUN dnf update && dnf install -y \
  cifs-utils \
  nmstate \
  python3-pip && \
  dnf clean all

# hadolint ignore=DL3013,DL3059
RUN python3 -m pip install --no-cache-dir --target /usr/lib/python3.12/site-packages --upgrade pip

# hadolint ignore=DL3013,DL3059
RUN python3 -m pip install --no-cache-dir --target /usr/lib/python3.12/site-packages \
  packaging \
  requests \
  setuptools \
  wheel

RUN curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
  chmod 700 get_helm.sh && \
  HELM_INSTALL_DIR=/usr/bin VERIFY_CHECKSUM=false ./get_helm.sh && \
  rm get_helm.sh

# hadolint ignore=DL3059
RUN /kairos-init \
  -s init \
  --fips \
  -p "${KUBERNETES_DISTRO}" \
  "${K8S_VERSION_FLAG}" "${KUBERNETES_VERSION}" \
  -l debug \
  -m "${MODEL}" \
  -t "${TRUSTED_BOOT}" \
  --version "${VERSION}"

# hadolint ignore=DL3059
RUN /kairos-init validate -t "${TRUSTED_BOOT}"

# hadolint ignore=DL3059
RUN rm /kairos-init
